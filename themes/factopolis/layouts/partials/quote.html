{{ $page := index $ 0 }}
{{ $stmt := index $ 1 }}
{{ $slug := replaceRE "^.*/([^/]+)/?$" "$1" $page.URL }}
<blockquote>
  <div class="quote-contents">
    {{ if $stmt.Params.retraction }}<del>{{end}}
    {{ if $stmt.Params.quote }}
      <p>
        {{ $stmt.Params.quote | markdownify }}
      </p>
    {{ end }}
    {{ if $stmt.Params.retraction }}</del>{{end}}
  </div>

  <footer>
    <cite>
      <div>
        <a href="{{ $stmt.Parent.Permalink }}">{{ $stmt.Parent.Title }}</a>{{ if $stmt.Params.where }},{{ else }} on {{ end }}
        <span class="dropdown show">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            {{ if $stmt.Params.where }}
              {{ $stmt.Params.where | title }}
            {{ else }}
              <time datetime="{{ $stmt.Params.date }}">
              {{ $stmt.Date | dateFormat "Jan 2, 2006" }}
              </time>
            {{ end }}
          </a>
          <div class="dropdown-menu">
            {{ range $source := $stmt.Params.sources }}
              {{ if eq $source.type "youtube" }}
                <a class="dropdown-item" {{ if $source.start }}data-start-time="{{ $source.start }}" {{ if $source.duration }}data-end-time="{{ add $source.start $source.duration }}"{{ end }}{{ end }} href="https://www.youtube.com/watch?v={{ $source.id }}{{ if $source.start }}&amp;t={{ $source.start }}{{  end }}" target="_blank">
                  <i class="fa fa-youtube" aria-hidden="true"></i>
                  YouTube {{ partial "time-range.html" $source }}
                </a>
              {{ else if eq $source.type "transcript" }}
               <a class="dropdown-item" href="{{ $source.url }}" target="_blank">
                  <i class="fa fa-file-text" aria-hidden="true"></i>
                  Transcript
                  ({{ replaceRE "[a-z]+://((www[0-9]*)\\.)?([^/]+)(/.*)?" "$3" $source.url }})
                </a>
              {{ else if eq $source.type "audio" }}
                <audio class="dropdown-item" controls preload="none" src="{{ $source.url }}{{ if $source.start }}#t={{ $source.start }}{{ if $source.duration }},{{ add $source.start $source.duration }}{{ end }}{{ end }}"></audio>
                {{ if $source.source }}
                  <a class="dropdown-item" href="#">
                    <i class="fa fa-headphones" aria-hidden="true"></i>
                    {{ default (replaceRE "[a-z]+://((www[0-9]*)\\.)?([^/]+)(/.*)?" "$3" $source.source) $source.name }}
                    {{ partial "time-range.html" $source }}
                  </a>
                {{ end }}
              {{ else if eq $source.type "video" }}
                <a class="dropdown-item video-link"
                href="{{ default $source.iframe (default $source.url $source.source) }}"
                    {{ if gt $source.start 0.0 }}data-start="{{ $source.start }}"{{ end }}
                    {{ if $source.duration }}data-duration="{{ $source.duration }}"{{ end }}
                    {{ if $source.source }}
                      data-source="{{ $source.source }}"
                    {{ end }}
                    {{ if $source.url }}
                      data-url="{{ $source.url }}"
                    {{ end }}
                    {{ if $source.iframe }}
                      data-iframe="{{ $source.iframe }}"
                    {{ end }}
                    target="_blank">
                  <i class="fa fa-film" aria-hidden="true"></i>
                  {{ default (replaceRE "[a-z]+://((www[0-9]*)\\.)?([^/]+)(/.*)?" "$3" $source.source) $source.name }}
                  {{ partial "time-range.html" $source }}
                </a>
              {{ else if eq $source.type "web" }}
                <a class="dropdown-item" href="{{ $source.url }}" target="_blank">
                  <i class="fa fa-globe" aria-hidden="true"></i>
                  {{ replaceRE "[a-z]+://((www[0-9]*)\\.)?([^/]+)(/.*)?" "$3" $source.url }}
                  {{ partial "time-range.html" $source }}
                </a>
              {{ else if eq $source.type "twitter" }}
                <a class="dropdown-item twitter-link" data-tweet="{{ $source.id }}" href="https://twitter.com/{{ $source.user }}/status/{{ $source.id }}">
                  <i class="fa fa-twitter" aria-hidden="true"></i>
                  Twitter (@{{ $source.user }})
                </a>
              {{ end }}
            {{ end }}
          </div>
        </span>
        {{ if $stmt.Params.where }}
          on
          <time datetime="{{ $stmt.Params.date }}">
            {{ $stmt.Date | dateFormat "Jan 2, 2006" }}
          </time>
        {{ end }}
      </div>
      {{ if $stmt.Params.retraction }}
        <div class="retraction">
          {{ if eq $stmt.Params.retraction.type "clarification" }}
            Clarified
          {{ else }}
            Retracted
          {{ end }}

          {{ if $stmt.Params.retraction.issuer }}
            by

            {{ if $stmt.Params.retraction.issuer.position }}
              {{ $stmt.Params.retraction.issuer.position }}
            {{ end }}

            {{ if $stmt.Params.retraction.issuer.id }}
              {{ $stmtretractor := $stmt.Site.GetPage "section" "person" $stmt.Params.retraction.issuer.id }}
              {{ if $stmtretractor }}
                <a href="{{ $stmtretractor.Permalink }}">
                  {{ $stmtretractor.Title }}
                </a>
              {{ else }}
                {{ (replace $stmt.Params.retraction.issuer.id "-" " ") | humanize }}
              {{ end }}
            {{ else }}
              {{ $stmt.Params.retraction.issuer.name }}
            {{ end }}
          {{ end }}

          on

          <a href="{{ $stmt.Params.retraction.source }}">
            <time datetime="{{ $stmt.Params.retraction.date }}">
              {{ $stmt.Params.retraction.date | dateFormat "Jan 2, 2006" }}
            </time>
          </a>
        </div>
      {{ end }}
    </cite>

    {{ if and (eq $page.Type "claims") (eq $page.Kind "taxonomy") }}
      {{ $page.Scratch.Set "##partials/quote.html/claims" (slice) }}
      {{ range $claim := $stmt.Params.claims }}
        {{ if ne $claim $slug }}
          {{ $page.Scratch.Add "##partials/quote.html/claims" $claim }}
        {{ end }}
      {{ end }}
    {{ else }}
      {{ $page.Scratch.Set "##partials/quote.html/claims" $stmt.Params.claims }}
    {{ end }}

    {{ if ($page.Scratch.Get "##partials/quote.html/claims") | len }}
      <section class="claims">
        {{ if and (eq $page.Type "claims") (eq $page.Kind "taxonomy") }}
          <h4>Other Claims</h4>
        {{ else }}
          <h4>Claims</h4>
        {{ end }}

        <ul class="subtle-list">
          {{ range $claimId := $page.Scratch.Get "##partials/quote.html/claims" }}
            <li>
            {{ $claim := $page.Site.GetPage "taxonomy" "claims" $claimId }}
            <h5>
              <a href="{{ $claim.Permalink }}">{{ $claim.Title }}</a>
            </h5>
            <div class="truth">
              {{ $claim.Params.summary | markdownify }}
            </div>
            </li>
          {{ end }}
        </ul>
      </section>
    {{ end }}

    {{ $page.Scratch.Set "##partials/quote.html/checks" (slice) }}
    {{ if $stmt.Params.checks }}
      {{ range $check := $stmt.Params.checks }}
        {{ if or (or (ne $page.Type "claims") (ne $page.Kind "taxonomy")) (or (not $check.claims) (in $check.claims $slug)) }}
          {{ $page.Scratch.Add "##partials/quote.html/checks" $check }}
        {{ end }}
      {{ end }}

      {{ $checks := $page.Scratch.Get "##partials/quote.html/checks" }}
      {{ if ($checks | len) }}
        <section class="fact-checks">
          <h4>Fact Checks</h4>

          {{ range $check := shuffle $checks }}
            <blockquote>
              <div class="quote-contents">
                {{ if $check.quote }}
                  {{ $check.quote | markdownify }}
                {{ else if $check.short }}
                  {{ $check.short | markdownify }}
                {{ else }}
                  QUOTE MISSING
                {{ end }}
              </div>

              <footer>
                <cite>
                  <div>
                    {{ $checker := $page.Site.GetPage "page" "checker" (printf "%s.md" $check.checker) }}
                    <a href="{{ $check.source }}">
                      {{ if $checker }}
                        {{ $checker.Title }}
                      {{ else }}
                        {{ $check.checker | title }}
                      {{ end }}
                    </a>
                  </div>
                </cite>
              </footer>
            </blockquote>
          {{ end }}
        </section>
      {{ end }}
    {{ end }}
  </footer>
</blockquote>
